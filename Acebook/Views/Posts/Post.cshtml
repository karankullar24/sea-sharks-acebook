@using Npgsql.EntityFrameworkCore.PostgreSQL.Query.Expressions.Internal
@using System.Linq
@using acebook.Controllers

@model acebook.Models.Post

<!-- Individual Post -->

<div class="flex flex-col items-center w-full">
    <div class="fixed top-20 z-40 w-full bg-white shadow-[inset_0_-1px_2px_rgba(0,0,0,0.05)]">
        <h1 id="splash-heading" class="mt-2 pb-2 font-bold text-center text-teal-700 text-xl">@Model.User.FirstName's
            Splash</h1>
    </div>
    <div class="bg-white mt-10 rounded-t-lg w-2/3 p-4 shadow-[0_0_15px_rgba(15,118,110,0.3)] z-30">
        <div class="flex justify-between items-center">
            <h3 class="text-md font-semibold text-gray-800">@Model.User.FirstName @Model.User.LastName</h3>
            <img src="/images/Placeholder.png" class="w-12 h-12 rounded-full object-cover border border-gray-400">
        </div>

        <p class="text-gray-700 mt-2 leading-relaxed">@Model.Content</p>
        <p class="text-xs text-gray-400 mt-4">Created on: @Model.FormattedCreatedOn</p>

    <!-- Buttons under post -->
    @* <div class="flex border-t border-gray-200 divide-x divide-gray-200 justify-evenly mt-4 pt-3"> *@
        @* <button class="relative flex-1 inline-flex items-center justify-center overflow-hidden text-gray-600 text-sm bg-transparent hover:bg-white group py-2 px-4 font-medium transition-all">
            <span class="absolute inset-0 bg-teal-600 translate-x-full ease-out duration-500 transition-all group-hover:translate-x-0"></span>
            <span class="relative text-gray-600 group-hover:text-white">Like (@Model.Likes?.Count)</span>
        </button> *@
        <div class="flex border-t border-gray-200 divide-x divide-gray-200 justify-around mt-4 pt-3">
            <button
                class="relative flex-1 inline-flex items-center justify-center overflow-hidden text-gray-600 text-sm bg-transparent group py-2 px-4 font-medium transition-all"
                data-testid = 'post-like-button'
                data-post-id="@Model.Id"
                data-liked="@Model.Likes.Any(l => l.UserId == Context.Session.GetInt32("user_id"))">
                <span
                    class="absolute inset-0 bg-teal-600 right-0 top-0 translate-x-full ease-out duration-500 transition-all group-hover:translate-x-0"></span>
                <span class="relative transition-colors duration-300 ease-in-out group-hover:text-white" data-testid ='post-like-total'>
                    Like (<span class="like-count">@Model.Likes.Count()</span>)
                </span>
            </button>

            <button class="relative flex-1 inline-flex items-center justify-center overflow-hidden text-gray-600 text-sm bg-transparent hover:bg-white group py-2 px-4 font-medium transition-all">
                <span class="absolute inset-0 bg-teal-600 translate-x-full ease-out duration-500 transition-all group-hover:translate-x-0"></span>
                <span class="relative text-gray-600 group-hover:text-white">View Profile</span>
            </button>

            @if (Model.UserId == Context.Session.GetInt32("user_id"))
            {
                <form action="/posts/@Model.Id/delete" method="post" class="flex-1" onsubmit="return confirm('Are you sure you want to delete this post?');">
                    <button data-testid="delete-post-button" type="submit"
                        class="relative w-full inline-flex items-center justify-center overflow-hidden text-gray-600 text-sm bg-transparent hover:bg-white group py-2 px-4 font-medium transition-all">
                        <span class="absolute inset-0 bg-red-600 right-0 top-0 translate-x-full ease-out duration-500 transition-all group-hover:translate-x-0"></span>
                        <span class="relative text-gray-600 group-hover:text-white">Delete Post</span>
                    </button>
                </form>
            }
        </div>
    </div>


    <!-- Background of Comments -->
    <div class="flex flex-col items-center w-2/3 bg-teal-700/10 rounded-b-lg shadow-[0_0_15px_rgba(15,118,110,0.3)] max-h-[70vh] overflow-hidden">

        <div class="flex-1 w-full overflow-y-auto px-4 py-4">

            @{
                List<Comment>? comments = ViewBag.comments as List<acebook.Models.Comment>;
            }

            @if (comments == null || !comments.Any())
            {
                <div id="NoCommentsMessage" class="flex items-center justify-center h-full px-4 py-4">
                    <h3 " class=" text-teal-600 font-semibold">No comments yet!</h3>
                </div>
            }

            @foreach (Comment comment in ViewBag.comments)
            {
                <div class="bg-white rounded w-full p-2 mt-2 shadow-md hidden md:flex items-start relative">
                    <img src="/images/Placeholder.png"
                        class="w-8 h-8 rounded-full object-cover border border-gray-400 mr-3">

                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h3 class="text-sm font-semibold text-gray-800">
                                @comment.User.FirstName @comment.User.LastName
                            </h3>

                            <form action="@Url.Action()" method="post">
                                <button
                                    class="comment-like relative inline-flex items-center justify-center overflow-hidden text-gray-600 text-xs bg-transparent group py-1 px-3 font-medium rounded-md transition-all border border-gray-200 shadow-sm"
                                    data-comment-id="@comment.Id"
                                    data-testid="comment-like-button"
                                    data-liked="@comment.Likes.Any(l => l.UserId == Context.Session.GetInt32("user_id"))">
                                    <span
                                        class="absolute inset-0 bg-teal-600 right-0 top-0 translate-x-full ease-out duration-500 transition-all group-hover:translate-x-0"></span>
                                    <span
                                        data-testid="comment-like-total" class="relative flex items-center transition-colors duration-300 ease-in-out group-hover:text-white">
                                        Like (<span class="comment-like-count">@comment.Likes.Count()</span>)
                                    </span>
                                </button>

                            </form>
                        </div>

                        <!-- Comment content  -->
                        <p class="text-gray-700 text-sm mt-1 leading-snug">@comment.Content</p>
                        
                        <!-- Commented on AND Delete Comment button  -->
                        <div class="flex justify-between items-start">
                            <p class="text-xs text-gray-400 mt-2">Commented on: @comment.FormattedCreatedOn</p>
                            @if (comment.UserId == Context.Session.GetInt32("user_id") || comment.Post.UserId == Context.Session.GetInt32("user_id"))
                            {
                                <form action="@Url.Action("Delete", "Comments", new { postId = Model.Id, commentId = comment.Id })" method="post" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                    <button data-testid="delete-comment-button" type="submit"
                                        class="relative inline-flex items-center overflow-hidden text-gray-600 text-xs bg-transparent hover:bg-white group py-1 px-3 font-medium rounded-md transition-all border border-gray-200 shadow-sm">
                                        <span class="absolute inset-0 bg-red-600 right-0 top-0 translate-x-full ease-out duration-500 transition-all group-hover:translate-x-0"></span>
                                        <span class="relative flex items-center text-gray-600 transition-colors duration-300 ease-in-out group-hover:text-white">
                                            <span class="ml-1">Delete Comment</span>  
                                        </span>
                                    </button>
                                </form>
                            }
                        </div>

                    </div>
                </div>
            }
        </div>

        <div class="bg-white rounded-b-lg w-full px-4 py-2 shadow-[0_0_15px_rgba(15,118,110,0.3)]">
            <h2 class="text-lg font-semibold mb-1">Add a comment</h2>
            <form action="@Url.Action("Create", "Comments")" method="post">
                <input type="hidden" name="returnURL" value="@Url.Action("Post", "Comments", new { id = Model.Id })" />
                <input type="hidden" name="postId" value="@Model.Id" />
                <textarea id="comment-box"
                    class="w-full resize-none border p-1 rounded-md focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-gray-400 focus:ring-opacity-25 transition-shadow duration-200"
                    name="Content" maxlength="2000" placeholder="Make a splash! (max 2000 characters)"></textarea>
                <div class="flex justify-between items-center mt-0">
                    <label class="flex items-center text-sm text-teal-500 hover:underline">Attach Image</label>
                    <button data-testid="comment-submit" type="submit"
                        class="bg-teal-600 text-white text-sm font-medium px-3 py-1 rounded-md hover:bg-teal-400">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // -------- Post Likes --------
            const postButtons = document.querySelectorAll('button[data-post-id]'); //Finding the tag i set earlier in the HTML.
            postButtons.forEach(button => { //checking if the post has been liked by the user. 
                const postId = button.dataset.postId;
                let liked = button.dataset.liked === 'True' || button.dataset.liked === 'true'; //Checking if the post is already liked. 
                if (liked) { //Making sure if Liked it holds the same format as the previous page. 
                    const bgSpan = button.querySelector('span.absolute');
                    if (bgSpan) bgSpan.classList.remove('translate-x-full', 'translate-y-full');
                    const textSpan = button.querySelector('span.relative');
                    if (textSpan) textSpan.classList.add('text-white');
                }

                button.addEventListener('click', async () => { //If clicked it will head to the controller to change the like status. 
                    try {
                        const response = await fetch(`/posts/${postId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) throw new Error('Network response was not ok');

                        const data = await response.json();
                        const countSpan = button.querySelector('.like-count');
                        if (countSpan) countSpan.textContent = data.likeCount; //Dynamically updates like number based on like/unlike status 

                        liked = !liked; 
                        button.dataset.liked = liked;

                        const bgSpan = button.querySelector('span.absolute');
                        const textSpan = button.querySelector('span.relative');
                        if (liked) {
                            if (bgSpan) bgSpan.classList.remove('translate-x-full', 'translate-y-full');
                            if (textSpan) textSpan.classList.add('text-white');
                        } else {
                            if (bgSpan) bgSpan.classList.add('translate-x-full', 'translate-y-full');
                            if (textSpan) textSpan.classList.remove('text-white');
                        } //above is the formatting for the onclick when liked or unliked. 
                    } catch (err) {
                        console.error('Error toggling post like:', err); //redundancy (issues will be send to the console)
                    }
                });
            });

            // Comment likes basically the same logic as above. 
            const commentButtons = document.querySelectorAll('button[data-comment-id]');
            commentButtons.forEach(button => {
                const commentId = button.dataset.commentId;
                let liked = button.dataset.liked === 'True' || button.dataset.liked === 'true';

                if (liked) {
                    const bgSpan = button.querySelector('span.absolute');
                    if (bgSpan) bgSpan.classList.remove('translate-x-full');
                    const textSpan = button.querySelector('span.relative');
                    if (textSpan) textSpan.classList.add('text-white');
                }

                button.addEventListener('click', async (e) => {
                    e.preventDefault();

                    try {
                        const response = await fetch(`/comments/${commentId}/like`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) throw new Error('Network response was not ok');

                        const data = await response.json();
                        const countSpan = button.querySelector('.comment-like-count');
                        if (countSpan) countSpan.textContent = data.likeCount;

                        liked = !liked;
                        button.dataset.liked = liked;

                        const bgSpan = button.querySelector('span.absolute');
                        const textSpan = button.querySelector('span.relative');
                        if (liked) {
                            if (bgSpan) bgSpan.classList.remove('translate-x-full');
                            if (textSpan) textSpan.classList.add('text-white');
                        } else {
                            if (bgSpan) bgSpan.classList.add('translate-x-full');
                            if (textSpan) textSpan.classList.remove('text-white');
                        }
                    } catch (err) {
                        console.error('Error toggling comment like:', err);
                    }
                });
            });

        });
    </script>